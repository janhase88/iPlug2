# WDL Windows Shared Resource Inventory

## Summary
- Catalogues process-wide globals and cached handles inside the WDL Windows helpers that must be isolated once the sandbox switch covers these modules.
- Highlights how current iPlug/IGraphics code paths interact with (or bypass) each helper so we can plan migration work without regressing shared state behaviour.

## Process-wide resources and risks

| Module | Resource | Lifetime & usage assumptions | Sandboxing considerations |
| --- | --- | --- | --- |
| `WDL/win32_utf8.c` | Combo-box hook state (`s_combobox_atom`) plus the property tag `WDL_UTF8_OLDPROCPROP` that stores subclass procedures and allocated buffers on HWNDs.【F:WDL/win32_utf8.c†L86-L118】【F:WDL/win32_utf8.c†L1547-L1729】 | Initialised lazily the first time a UTF-8 hook is installed, then reused for every combo/list/tree control inside the host process. Each hooked control stores its buffers under a fixed property name, and the static fallback buffer `s_buf` is shared when callers forget to hook the control.【F:WDL/win32_utf8.c†L1676-L1729】 | A sandboxed instance must supply its own atom/property namespace and buffer storage so combo-box edits and `SetProp` lifetimes do not leak between plug-ins. The sandbox context should hand back per-instance structures for hooks instead of touching static globals. |
| `WDL/filebrowse.cpp` + `WDL/win7filedialog.cpp` | Global toggle `wdl_use_legacy_filebrowse` plus cached COM helpers inside `Win7FileDialog` that rely on a static function pointer for `SHCreateItemFromParsingName`.【F:WDL/filebrowse.cpp†L161-L220】【F:WDL/win7filedialog.cpp†L89-L120】 | The legacy flag is a plain global controlling whether Vista/Win7 dialogs are used, so flipping it affects all plug-ins in the process. The COM helper caches the `SHCreateItemFromParsingName` pointer the first time any dialog is shown.【F:WDL/win7filedialog.cpp†L89-L118】 | When sandbox mode is active, the legacy toggle and cached shell pointers need to live in sandbox-owned storage. Otherwise one instance can silently change the dialog mode for every other plug-in sharing the host process. |
| `WDL/win32_hidpi.h` | Static DPI awareness cache: `_WDL_dpi_func` stores the `SetThreadDpiAwarenessContext` function pointer, and `WDL_mmSetWindowPos` memoises awareness mode in the `init` flag.【F:WDL/win32_hidpi.h†L12-L61】 | The first caller loads `user32.dll`, caches the pointers, and records whether per-window repositioning should happen. Every subsequent window operation reuses that global `init`/function state. | Sandboxed plug-ins need per-context DPI caches so experimental DPI modes (or deliberate resets) in one instance do not bleed into others. Hoist these caches into the sandbox context and reset them whenever a sandbox is created or destroyed. |
| `WDL/wingui/wndsize.cpp` | `WDL_WndSizer::calc_dpi()` memoises `GetDpiForWindow` in the static pointer `__GetDpiForWindow` and treats the sentinel value `1` as “not available”.【F:WDL/wingui/wndsize.cpp†L412-L438】 | Once cached, every resizer shares the same function pointer and sentinel across the process, assuming the host’s DPI awareness mode stays constant. | Move the cached function pointer into sandbox state or expose an override hook so each plug-in instance can respond to host-specific DPI changes without relying on a process-global sentinel. |
| `WDL/wingui/virtwnd.cpp` | Helper-class registration flag (`reg`), stored dialog procedure (`vwndDlgHost_oldProc`), and the global cursor guard `wdl_virtwnd_nosetcursorpos`.【F:WDL/wingui/virtwnd.cpp†L1751-L1791】 | Registering the helper class is a one-shot operation guarded by the static `reg` flag; the stored WNDPROC and the cursor toggle then apply to every virtual window created afterwards. | If virtual windows ever back iPlug editors, the sandbox context must own the registered class metadata and cursor toggle so pen/touch behaviour remains isolated per plug-in instance. |

## Integration touchpoints today
- `IGraphicsWin::PromptForFile/PromptForDirectory` still call raw Win32 dialogs and perform their own UTF-8/UTF-16 conversions instead of using WDL wrappers, so adopting `win32_utf8` and `filebrowse` would centralise that logic but currently offers no per-instance isolation.【F:IGraphics/Platforms/IGraphicsWin.cpp†L2205-L2311】
- Mouse cursor hiding/locking is maintained inside `IGraphicsWin`, which mirrors the behaviour guarded by `wdl_virtwnd_nosetcursorpos`; future `WDL_VWnd` adoption must respect the existing per-instance cursor state stored on `IGraphicsWin` objects.【F:IGraphics/Platforms/IGraphicsWin.cpp†L946-L992】
- The existing sandbox bootstrap already places `gHINSTANCE` and DPI helpers behind per-instance storage using the `IPLUG_SANDBOX_*` macros, providing a template for how the WDL caches should be hoisted once the context object exists.【F:IPlug/IPlug_include_in_plug_src.h†L27-L69】

## Next steps for the audit
- Map additional globals surfaced while plumbing the WDL wrappers (e.g., per-control `SetProp` payloads) into the forthcoming sandbox context proposal.
- Use this inventory when drafting the sandbox-aware API design so each resource listed above gains a clear owner and lifetime inside the sandbox configuration.
